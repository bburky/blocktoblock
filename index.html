<!doctype html> 
<meta charset="utf-8" />
<title>Block to Block</title>
<style>
canvas {
    position: absolute;
    margin: auto;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/phaser/1.1.5/phaser.min.js"></script>
<script>window.Phaser || document.write('<script src="js/phaser.min.js"><\/script>')</script>
<script>
var BLOCK_SIZE = 45;
var PLAYER_SPEED = BLOCK_SIZE*5;

var players, blocks;
var upKey, downKey, leftKey, rightKey, wKey, aKey, sKey, dKey;

var player1, player2

// FIXME: debug
var block, block2;

function preload() {
    game.load.image('player-1', 'img/player-1.png');
    game.load.image('player-2', 'img/player-2.png');
    game.load.image('block-blue', 'img/block-blue.png');
    game.load.image('block-red', 'img/block-red.png');
    game.load.image('block-green', 'img/block-green.png');
    game.load.image('block-goal', 'img/block-goal.png');
}

function create() {
    blocks = game.add.group();
    players = game.add.group();

    player1 = players.create(BLOCK_SIZE*5, 0, 'player-1', players);
    // player1.body.setRectangle(5, 5, BLOCK_SIZE/2-2, BLOCK_SIZE/2-2);
    player1.oldPosition = player1.topLeft;

    player2 = players.create(0, 0, 'player-2', players);
    // player2.body.setRectangle(5, 5, BLOCK_SIZE/2-2, BLOCK_SIZE/2-2);
    player2.oldPosition = player2.topLeft;

    block = blocks.create(BLOCK_SIZE*2, 0, 'block-blue', blocks);
    block.body.setRectangle(BLOCK_SIZE-10, BLOCK_SIZE-10, 5, 5);
    block.body.immovable = true;

    block2 = blocks.create(BLOCK_SIZE*6, 0, 'block-green', blocks);
    block2.body.setRectangle(BLOCK_SIZE-10, BLOCK_SIZE-10, 5, 5);
    block2.body.immovable = true;

    upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
    downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
    leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
    rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
    wKey = game.input.keyboard.addKey(Phaser.Keyboard.W);
    aKey = game.input.keyboard.addKey(Phaser.Keyboard.A);
    sKey = game.input.keyboard.addKey(Phaser.Keyboard.S);
    dKey = game.input.keyboard.addKey(Phaser.Keyboard.D);

}

function update() {
    if (upKey.isDown && !isMoving(player1)) {
        if (!anyMoving()) player1.body.setRectangle(BLOCK_SIZE, 8, 0, BLOCK_SIZE-4);
        player1.oldPosition = player1.topLeft;
        player1.body.velocity.y = -PLAYER_SPEED;
    } else if (downKey.isDown && !isMoving(player1)) {
        if (!anyMoving()) player1.body.setRectangle(BLOCK_SIZE, 8, 0, -4);
        player1.oldPosition = player1.topLeft;
        player1.body.velocity.y = PLAYER_SPEED;
    } else if (leftKey.isDown && !isMoving(player1)) {
        if (!anyMoving()) player1.body.setRectangle(8, BLOCK_SIZE, BLOCK_SIZE-4, 0);
        player1.oldPosition = player1.topLeft;
        player1.body.velocity.x = -PLAYER_SPEED;
    } else if (rightKey.isDown && !isMoving(player1)) {
        if (!anyMoving()) player1.body.setRectangle(8, BLOCK_SIZE, -4, 0);
        player1.oldPosition = player1.topLeft;
        player1.body.velocity.x = PLAYER_SPEED;
    }

    if (wKey.isDown && !isMoving(player2)) {
        if (!anyMoving()) player2.body.setRectangle(BLOCK_SIZE, 8, 0, BLOCK_SIZE-4);
        player2.oldPosition = player2.topLeft;
        player2.body.velocity.y = -PLAYER_SPEED;
    } else if (sKey.isDown && !isMoving(player2)) {
        if (!anyMoving()) player2.body.setRectangle(BLOCK_SIZE, 8, 0, -4);
        player2.oldPosition = player2.topLeft;
        player2.body.velocity.y = PLAYER_SPEED;
    } else if (aKey.isDown && !isMoving(player2)) {
        if (!anyMoving()) player2.body.setRectangle(8, BLOCK_SIZE, BLOCK_SIZE-4, 0);
        player2.oldPosition = player2.topLeft;
        player2.body.velocity.x = -PLAYER_SPEED;
    } else if (dKey.isDown && !isMoving(player2)) {
        if (!anyMoving()) player2.body.setRectangle(8, BLOCK_SIZE, -4, 0);
        player2.oldPosition = player2.topLeft;
        player2.body.velocity.x = PLAYER_SPEED;
    }

    game.physics.overlap(players, blocks, playerBlockCollideCallback);
    game.physics.overlap(players, players, playerPlayerCollideCallback, playerProcessCallback);
}

function render() {
    // FIXME: debug
    game.debug.renderBodyInfo(player1, 0, 400);
    game.debug.renderPhysicsBody(player1.body);
    game.debug.renderPhysicsBody(player2.body);
    game.debug.renderPhysicsBody(block.body);
    game.debug.renderPhysicsBody(block2.body);
}

function playerBlockCollideCallback(player, block) {
    player.body.setRectangle(BLOCK_SIZE, BLOCK_SIZE, 0, 0);

    player.body.x = block.x;
    player.body.y = block.y;
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;

    block.kill();
}

function playerPlayerCollideCallback(playerA, playerB) {
    var playerFirst = isMoving(playerA) ? playerA : playerB;
    var playerStopped = playerA == playerFirst ? playerA : playerB;

    playerA.body.setRectangle(BLOCK_SIZE, BLOCK_SIZE, 0, 0);
    playerA.body.setRectangle(BLOCK_SIZE, BLOCK_SIZE, 0, 0);

    playerA.body.x = Math.round(playerA.x / BLOCK_SIZE) * BLOCK_SIZE;
    playerA.body.y = Math.round(playerA.y / BLOCK_SIZE) * BLOCK_SIZE;
    playerA.body.velocity.x = 0;
    playerA.body.velocity.y = 0;

    playerB.body.x = playerA.body.x;
    playerB.body.y = playerA.body.y;
    playerB.body.velocity.x = 0;
    playerB.body.velocity.y = 0;
}

function isMoving(sprite) {
    return sprite.body.velocity.x !== 0 || sprite.body.velocity.y !== 0;
}

function anyMoving() {
    return isMoving(player1) || isMoving(player2);
}

function playerProcessCallback (playerA, playerB) {
    return !(playerA.oldPosition.equals(playerB.topLeft) || playerB.oldPosition.equals(playerA.topLeft));
}

var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render });
</script>
