<!doctype html>
<meta charset="utf-8" />
<title>Block to Block</title>
<style>
canvas {
    position: absolute;
    margin: auto;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/phaser/1.1.5/phaser.min.js"></script>
<script>window.Phaser || document.write('<script src="js/phaser.min.js"><\/script>')</script>
<script>
var BLOCK_SIZE = 45;
var PLAYER_SPEED = BLOCK_SIZE*5;
var DIRECTION = {none: 0, up: 1, right: 2, down: 3, left: 4};

var upKey, downKey, leftKey, rightKey, wKey, aKey, sKey, dKey;
var players, blocks;
var player1, player2
var collidingPlayer;

function preload() {
    game.load.image('player-1', 'img/player-1.png');
    game.load.image('player-2', 'img/player-2.png');
    game.load.image('block-blue', 'img/block-blue.png');
    game.load.image('block-red', 'img/block-red.png');
    game.load.image('block-green', 'img/block-green.png');
    game.load.image('block-goal', 'img/block-goal.png');
}

function create() {
    upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
    downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
    leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
    rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
    wKey = game.input.keyboard.addKey(Phaser.Keyboard.W);
    dKey = game.input.keyboard.addKey(Phaser.Keyboard.D);
    aKey = game.input.keyboard.addKey(Phaser.Keyboard.A);
    sKey = game.input.keyboard.addKey(Phaser.Keyboard.S);

    blocks = game.add.group();
    players = game.add.group();

    player1 = players.create(0, 0, 'player-1', players);
    player1.name = 'player left';
    player1.destination = player1.topLeft;
    player1.direction = DIRECTION.none;
    player1.moving = false;

    player2 = players.create(BLOCK_SIZE*5, 0, 'player-2', players);
    player2.name = 'player right';
    player2.destination = player2.topLeft;
    player2.direction = DIRECTION.none;
    player2.moving = false;

    blocks.create(BLOCK_SIZE*2, 0, 'block-blue', blocks);
    blocks.create(BLOCK_SIZE*6, 0, 'block-green', blocks);
}

function update() {
    if (wKey.isDown && player1.direction === DIRECTION.none) {
        player1.direction = DIRECTION.up;
    } else if (sKey.isDown && player1.direction === DIRECTION.none) {
        player1.direction = DIRECTION.down;
    } else if (aKey.isDown && player1.direction === DIRECTION.none) {
        player1.direction = DIRECTION.left;
    } else if (dKey.isDown && player1.direction === DIRECTION.none) {
        player1.direction = DIRECTION.right;
    }

    if (upKey.isDown && player2.direction === DIRECTION.none) {
        player2.direction = DIRECTION.up;
    } else if (downKey.isDown && player2.direction === DIRECTION.none) {
        player2.direction = DIRECTION.down;
    } else if (leftKey.isDown && player2.direction === DIRECTION.none) {
        player2.direction = DIRECTION.left;
    } else if (rightKey.isDown && player2.direction === DIRECTION.none) {
        player2.direction = DIRECTION.right;
    }

    for (var i = 0; i < players.length; i++) {
        var player = players.getAt(i);
        if (!player.moving) {
            switch (player.direction) {
                case DIRECTION.up:
                    var newPosition = player.topLeft.clone();
                    newPosition.y -= BLOCK_SIZE;
                    goToPoint(player, newPosition);
                    break;

                case DIRECTION.down:
                    var newPosition = player.topLeft.clone();
                    newPosition.y += BLOCK_SIZE;
                    goToPoint(player, newPosition);
                    break;

                case DIRECTION.left:
                    var newPosition = player.topLeft.clone();
                    newPosition.x -= BLOCK_SIZE;
                    goToPoint(player, newPosition);
                    break;

                case DIRECTION.right:
                    var newPosition = player.topLeft.clone();
                    newPosition.x += BLOCK_SIZE;
                    goToPoint(player, newPosition);
                    break;
            }
        }
    }
}

function goToPoint(player, point) {
    // using global collidingPlayer
    var collidingBlock;

    for (var i = 0; i < blocks.length; i++) {
        var block = blocks.getAt(i)
        if (block.alive) {
            if (block.topLeft.equals(point)) {
                collidingBlock = block;
                break;
            }
        }
    }

    for (var i = 0; i < players.length; i++) {
        var otherPlayer = players.getAt(i)
        if (otherPlayer !== player) {
            if (otherPlayer.destination.equals(point)) {
                collidingPlayer = otherPlayer;
                break;
            }
        }
    }

    player.moving = true;
    player.destination = point;
    var tween = game.add.tween(player);
    tween.to({x: point.x, y: point.y}, PLAYER_SPEED);
    tween.onComplete.add(function() {
        player.moving = false;

        if (collidingBlock) {
            collidingBlock.kill();
            player.direction = DIRECTION.none;
        }

        // This may have been set by the other player
        if (collidingPlayer) {
            player.direction = DIRECTION.none;
            if (collidingPlayer !== player) {
                collidingPlayer = undefined;
            }
        }

        player.topLeft = point; // Should I actually assign to topLeft?
    });
    tween.start();
}

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
</script>
